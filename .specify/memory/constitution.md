<!--
Sync Impact Report
- Version: 1.0.0 → 1.1.0
- Modified Principles: 无
- Added Sections: 无
- Removed Sections: 无
- Templates requiring updates:
  - .specify/templates/plan-template.md ✅
  - .specify/templates/spec-template.md ✅
  - .specify/templates/tasks-template.md ✅
- Follow-up TODOs: 无
-->

# wvp-GB28181-pro Constitution

## Core Principles

### I. 安全合规与可信访问（不可妥协）
- 国标/部标信令与媒体接入必须开启认证并最小化权限，默认拒绝未授权来源。
- 所有跨网络、跨平台调用记录审计日志（含设备ID、平台ID、操作人、结果），可追溯到具体请求。
- 秘钥、证书、令牌不得明文入库，统一使用环境变量或密钥管理服务，轮换需可审计。
- 理由：视频与位置数据敏感，合规与安全是上线硬门槛。

### II. 可观测性与问题可追溯
- 统一结构化日志，信令/媒体/HTTP 链路透传 trace/span id，便于端到端定位。
- 指标至少覆盖：注册与心跳成功率、回放/推流成功率、媒体节点健康度、延迟与卡顿率。
- 告警必须可路由，关键指标或 SLO 退化时阻断上线或触发自动降级。
- 理由：跨网络、跨节点链路复杂，观测缺口会导致长尾故障难以恢复。

### III. 测试优先与回归防护
- 新协议交互、对外接口或兼容性变更必须有契约/集成测试；核心业务路径需自动化校验。
- Bug 修复需附带回归用例；CI 至少执行单测 + 核心链路集成/契约测试。
- 本地或 CI 必须可一键拉起核心依赖（如 docker-compose）复现与验证。
- 理由：协议/设备多样，缺少自动化将导致回归频发且难以复现。

### IV. 配置即代码与环境一致性
- 配置、拓扑、初始化脚本需纳入版本控制，环境差异通过参数化/模板化而非手工修改。
- 低环境尽量复用生产拓扑与组件类型（如 ZLM 节点、数据库类型），差异需在文档标注。
- 容器镜像命名遵循 `starmetal/<service>:<version>`，禁止漂移的 `latest` 或无前缀标签。
- 理由：环境偏差直接放大联调与上线风险，统一规范可降低不可预期差异。

### V. 性能韧性与降级
- 接入、推流、回放路径需设定性能基线（延迟、并发、丢包耐受范围）并在发布前验证。
- 关键依赖超时或失败必须有降级与限流策略（如自动切换节点、降档转码、隔离问题设备）。
- 性能优化前先度量，变更后需可回滚，确保用户体验优先于微观优化。
- 理由：视频业务对时延与稳定性敏感，韧性策略是持续可用的保障。

## 工程约束

- 容器镜像与发布：所有服务默认镜像 tag 前缀为 `starmetal/`，版本号与代码发行对齐；禁止未追踪来源的镜像进入环境。
- 配置与密钥管理：配置文件、环境变量示例与说明需随代码提交；密钥通过密管或环境注入，不落盘、不进仓。
- 数据与隐私：存储与传输遵循最小化收集原则，审计日志不得包含敏感明文；导出数据需可追溯来源与授权。
- 兼容性：国标/部标及主要厂商设备的兼容性变更需在发布说明中列出影响面与验证范围。

## 研发流程与质量门禁

- Constitution Check：在需求/方案阶段运行，明确是否满足核心原则与工程约束；未通过前不得进入实现。
- 评审要求：设计评审需覆盖安全、观测、性能与部署影响；代码评审需验证测试覆盖与镜像/配置规范。
- 发布准入：发布前需提供可重复的验证步骤（含 docker-compose/脚本）、基线指标对比与回滚方案。
- 依赖与变更管理：引入或升级关键依赖需记录风险与回滚路径；协议/接口变更必须更新契约与测试。

## Governance

- 本宪章优先于其他工程惯例，如有冲突需先更新或豁免本宪章并形成记录。
- 修订流程：提出变更→评审安全/观测/测试/交付影响→确定迁移与回滚计划→更新版本号与日期→通知全体贡献者。
- 版本策略：采用语义化版本
  - MAJOR：移除或重大重定义原则/治理方式
  - MINOR：新增原则或显著扩展约束
  - PATCH：表述澄清、不改语义
- 合规检查：PR、CI、发布前检查须显式标记宪章符合性，违反项需列出理由与整改计划；重大违规应阻断上线。
- 提交规范：Git 提交消息遵循 `<type>(<scope>): <subject>` 约定，type 取自常见枚举（feat/fix/docs/style/refactor/perf/test/chore/revert/build），subject 超过两点时使用要点列表分行描述，避免自动提交或无测试验证的提交（参考 [git.mdc](https://raw.githubusercontent.com/rikugun/cursor-rules/main/other/git.mdc)）。

**Version**: 1.1.0 | **Ratified**: 2025-12-06 | **Last Amended**: 2025-12-06
